{% extends "layouts/base.html" %}

{% block title %}Dados Salvos · ATX Coverage{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3 mb-4">
        <div>
            <h2 class="page-heading mb-1">Resumo do usuário</h2>
            <p class="text-muted mb-0">Parâmetros atuais e artefatos gerados pelas ferramentas de cobertura.</p>
        </div>
        <a class="btn btn-outline-primary" href="{{ url_for('ui.home') }}">Voltar ao painel</a>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">Parâmetros principais</h5>
            <div class="row g-3 small text-muted">
                <div class="col-sm-6 col-lg-3"><strong>Usuário:</strong> {{ dados_salvos.username }}</div>
                <div class="col-sm-6 col-lg-3"><strong>Email:</strong> {{ dados_salvos.email }}</div>
                <div class="col-sm-6 col-lg-3"><strong>Serviço:</strong> {{ dados_salvos.servico or '—' }}</div>
                <div class="col-sm-6 col-lg-3"><strong>Ambiente:</strong> {{ dados_salvos.propagation_model or '—' }}</div>
                <div class="col-sm-6 col-lg-3"><strong>Frequência:</strong> {{ dados_salvos.frequencia or '—' }} MHz</div>
                <div class="col-sm-6 col-lg-3"><strong>Potência TX:</strong> {{ dados_salvos.transmission_power or '—' }} W</div>
                {% set gain_dbd = dados_salvos.antenna_gain - 2.15 if dados_salvos.antenna_gain is not none else None %}
                <div class="col-sm-6 col-lg-3"><strong>Ganho antena:</strong> {{ gain_dbd|round(2) if gain_dbd is not none else '—' }} dBd</div>
                <div class="col-sm-6 col-lg-3"><strong>Perdas sistema:</strong> {{ dados_salvos.total_loss or '—' }} dB</div>
                <div class="col-sm-6 col-lg-3"><strong>Altitude TX:</strong> {{ dados_salvos.tx_site_elevation or '—' }} m</div>
                <div class="col-sm-6 col-lg-3"><strong>Coordenadas:</strong> {{ dados_salvos.latitude or '—' }}, {{ dados_salvos.longitude or '—' }}</div>
                <div class="col-sm-6 col-lg-3"><strong>Polarização:</strong> {{ dados_salvos.polarization or '—' }}</div>
                <div class="col-sm-6 col-lg-3"><strong>Notas:</strong> {{ dados_salvos.notes or '—' }}</div>
            </div>
        </div>
    </div>

    <section class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Últimas manchas de cobertura</h5>
            <small class="text-muted">As imagens são vinculadas automaticamente aos projetos correspondentes.</small>
        </div>
        <div class="row g-4">
            {% for card in coverage_cards %}
            <div class="col-md-6 col-xl-4">
                <div class="card h-100 shadow-sm">
                    {% if card.preview_url %}
                        <img src="{{ card.preview_url }}" class="card-img-top" alt="Prévia da cobertura">
                    {% endif %}
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title mb-1">{{ card.project.name }}</h6>
                        <p class="text-muted small mb-2">
                            {% if card.generated_at %}Gerada em {{ card.generated_at }}{% else %}Sem data registrada{% endif %}
                            {% if card.engine %} · Motor {{ card.engine|upper }}{% endif %}
                        </p>
                        {% set center_metrics = card.center_metrics %}
                        {% if center_metrics %}
                            <ul class="list-unstyled small text-muted mb-3">
                            </ul>
                        {% endif %}
                        <div class="mt-auto d-flex gap-2">
                            <a class="btn btn-sm btn-brand flex-grow-1" href="{{ card.detail_url }}">Abrir projeto</a>
                            {% if card.preview_url %}
                                <a class="btn btn-sm btn-outline-secondary" href="{{ card.preview_url }}" target="_blank">Ver imagem</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12">
                <div class="alert alert-info">Nenhuma cobertura foi gerada ainda. Utilize a aba <em>Planejar cobertura</em> para produzir a primeira mancha.</div>
            </div>
            {% endfor %}
        </div>
    </section>

    <section class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Artefatos legados</h5>
            <small class="text-muted">Conteúdo armazenado no perfil do usuário.</small>
        </div>
        <div class="row g-4">
            {% if image_data.perfil_img %}
            <div class="col-md-6 col-xl-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-title">Perfil de elevação</h6>
                        <img src="data:image/png;base64,{{ image_data.perfil_img }}" alt="Perfil de elevação" class="img-fluid rounded">
                    </div>
                </div>
            </div>
            {% endif %}
            {% if image_data.cobertura_img %}
            <div class="col-md-6 col-xl-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-title">Cobertura (versão histórica)</h6>
                        <img src="data:image/png;base64,{{ image_data.cobertura_img }}" alt="Cobertura" class="img-fluid rounded">
                    </div>
                </div>
            </div>
            {% endif %}
            {% if image_data.antenna_pattern_img_dia_H %}
            <div class="col-md-6 col-xl-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-title">Diagrama horizontal</h6>
                        <img src="data:image/png;base64,{{ image_data.antenna_pattern_img_dia_H }}" alt="Diagrama horizontal" class="img-fluid rounded">
                    </div>
                </div>
            </div>
            {% endif %}
            {% if image_data.antenna_pattern_img_dia_V %}
            <div class="col-md-6 col-xl-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-title">Diagrama vertical</h6>
                        <img src="data:image/png;base64,{{ image_data.antenna_pattern_img_dia_V }}" alt="Diagrama vertical" class="img-fluid rounded">
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </section>
</div>
{% endblock %}
